<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Inventory System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Your existing CSS styles */
        .user-section { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .material-table th { background-color: #e9ecef; }
        .action-cell { min-width: 150px; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <h2 class="text-center mb-4">Material Inventory System</h2>
        <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" placeholder="Enter your username" required>
        </div>
        <div class="mb-3">
            <label for="apiKey" class="form-label">JSONBin API Key (Get free from jsonbin.io)</label>
            <input type="password" class="form-control" id="apiKey" placeholder="Enter your JSONBin API key">
            <small class="text-muted">All users must use the same API key for shared data</small>
        </div>
        <div class="mb-3">
            <label for="binId" class="form-label">JSONBin ID (Optional)</label>
            <input type="text" class="form-control" id="binId" placeholder="Leave empty to create new">
            <small class="text-muted">Share this ID with other users</small>
        </div>
        <button id="loginBtn" class="btn btn-primary w-100">Login & Connect</button>
        
        <div class="mt-3 text-center">
            <a href="https://jsonbin.io" target="_blank" class="btn btn-outline-secondary btn-sm">Get Free API Key</a>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="appSection" class="container mt-4 hidden">
        <!-- User Info Section -->
        <div class="user-section">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4>Welcome, <span id="currentUser" class="text-primary"></span>!</h4>
                    <small class="text-muted">Cloud Storage: JSONBin.io | Bin ID: <span id="currentBinId"></span></small>
                </div>
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <span class="status-indicator" id="connectionStatus"></span>
                        <span id="lastSync"></span>
                    </div>
                    <button id="logoutBtn" class="btn btn-outline-secondary">Logout</button>
                </div>
            </div>
        </div>

        <!-- Rest of your HTML remains the same -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Add New Material</h5>
            </div>
            <div class="card-body">
                <form id="materialForm">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="materialName" class="form-label">Material Name</label>
                            <input type="text" class="form-control" id="materialName" required>
                        </div>
                        <div class="col-md-4">
                            <label for="productNumber" class="form-label">Product Number</label>
                            <input type="text" class="form-control" id="productNumber" required>
                        </div>
                        <div class="col-md-4">
                            <label for="referenceCode" class="form-label">Reference Code</label>
                            <input type="text" class="form-control" id="referenceCode" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="productCategory" class="form-label">Product Category</label>
                            <input type="text" class="form-control" id="productCategory" required>
                        </div>
                        <div class="col-md-4">
                            <label for="purchaseUom" class="form-label">Purchase UoM</label>
                            <input type="text" class="form-control" id="purchaseUom" required>
                        </div>
                        <div class="col-md-4">
                            <label for="spmsCode" class="form-label">SPMS Code or English Name</label>
                            <input type="text" class="form-control" id="spmsCode" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="priceIqd" class="form-label">Price IQD</label>
                            <input type="number" step="0.01" class="form-control" id="priceIqd" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Add Material</button>
                </form>
            </div>
        </div>

        <!-- Materials Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Material Inventory</h5>
                <div>
                    <button id="refreshDataBtn" class="btn btn-outline-primary btn-sm me-2">Refresh Data</button>
                    <button id="exportDataBtn" class="btn btn-outline-success btn-sm me-2">Export Data</button>
                    <button id="shareBinBtn" class="btn btn-outline-info btn-sm me-2">Share Bin ID</button>
                    <button id="clearAllBtn" class="btn btn-danger btn-sm">Clear All</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover material-table">
                        <thead>
                            <tr>
                                <th>Material Name</th>
                                <th>Product Number</th>
                                <th>Reference Code</th>
                                <th>Product Category</th>
                                <th>Purchase UoM</th>
                                <th>SPMS Code</th>
                                <th>Price IQD</th>
                                <th class="action-cell">Added By</th>
                                <th class="action-cell">Added Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="materialsTableBody">
                            <!-- Materials will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // App state
        let currentUser = null;
        let apiKey = null;
        let binId = null;
        let materials = [];
        let syncInterval = null;

        // DOM elements
        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const usernameInput = document.getElementById('username');
        const apiKeyInput = document.getElementById('apiKey');
        const binIdInput = document.getElementById('binId');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUserSpan = document.getElementById('currentUser');
        const currentBinIdSpan = document.getElementById('currentBinId');
        const materialForm = document.getElementById('materialForm');
        const materialsTableBody = document.getElementById('materialsTableBody');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const shareBinBtn = document.getElementById('shareBinBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const lastSyncSpan = document.getElementById('lastSync');

        // JSONBin API configuration
        const JSONBIN_BASE_URL = 'https://api.jsonbin.io/v3/b';

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners
            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            materialForm.addEventListener('submit', handleAddMaterial);
            clearAllBtn.addEventListener('click', handleClearAll);
            refreshDataBtn.addEventListener('click', refreshData);
            exportDataBtn.addEventListener('click', exportData);
            shareBinBtn.addEventListener('click', shareBinId);

            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            const savedApiKey = localStorage.getItem('apiKey');
            const savedBinId = localStorage.getItem('binId');
            
            if (savedUser && savedApiKey) {
                usernameInput.value = savedUser;
                apiKeyInput.value = savedApiKey;
                if (savedBinId) binIdInput.value = savedBinId;
                loginUser(savedUser, savedApiKey, savedBinId);
            }
        });

        // Login handler
        async function handleLogin() {
            const username = usernameInput.value.trim();
            const userApiKey = apiKeyInput.value.trim();
            const userBinId = binIdInput.value.trim();
            
            if (!username || !userApiKey) {
                alert('Please enter both username and API key');
                return;
            }

            try {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Connecting...';
                
                await loginUser(username, userApiKey, userBinId);
            } catch (error) {
                alert('Login failed: ' + error.message);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login & Connect';
            }
        }

        // Login user
        async function loginUser(username, userApiKey, userBinId) {
            currentUser = username;
            apiKey = userApiKey;
            
            localStorage.setItem('currentUser', username);
            localStorage.setItem('apiKey', userApiKey);

            // If no binId provided, create a new bin
            if (!userBinId) {
                binId = await createNewBin();
                localStorage.setItem('binId', binId);
                binIdInput.value = binId;
            } else {
                binId = userBinId;
                // Test if bin exists and is accessible
                await testBinAccess();
            }

            currentUserSpan.textContent = username;
            currentBinIdSpan.textContent = binId;
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            
            // Start periodic data sync
            startSync();
            
            // Load initial data
            await refreshData();
            
            showToast('Connected to cloud storage successfully!', 'success');
        }

        // Test bin access
        async function testBinAccess() {
            try {
                const response = await fetch(`${JSONBIN_BASE_URL}/${binId}/latest`, {
                    headers: {
                        'X-Master-Key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Cannot access bin. Check your API key and Bin ID.');
                }
            } catch (error) {
                throw new Error('Cannot access bin: ' + error.message);
            }
        }

        // Create new bin
        async function createNewBin() {
            const response = await fetch(JSONBIN_BASE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': apiKey,
                    'X-Bin-Name': 'Material Inventory Data'
                },
                body: JSON.stringify([])
            });

            if (!response.ok) {
                throw new Error('Failed to create new storage bin');
            }

            const data = await response.json();
            return data.metadata.id;
        }

        // Logout handler
        function handleLogout() {
            currentUser = null;
            apiKey = null;
            binId = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('apiKey');
            localStorage.removeItem('binId');
            loginSection.classList.remove('hidden');
            appSection.classList.add('hidden');
            
            // Stop periodic sync
            stopSync();
        }

        // Start periodic data synchronization
        function startSync() {
            // Sync every 5 seconds
            syncInterval = setInterval(() => {
                refreshData();
            }, 5000);
        }

        // Stop periodic data synchronization
        function stopSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        // Refresh data from JSONBin
        async function refreshData() {
            try {
                const response = await fetch(`${JSONBIN_BASE_URL}/${binId}/latest`, {
                    headers: {
                        'X-Master-Key': apiKey
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    materials = data.record || [];
                    renderMaterials();
                    updateLastSyncTime();
                    connectionStatus.className = 'status-indicator status-online';
                } else {
                    throw new Error('Failed to fetch data');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                connectionStatus.className = 'status-indicator status-offline';
                showToast('Error connecting to cloud storage', 'danger');
            }
        }

        // Update last sync time display
        function updateLastSyncTime() {
            const now = new Date();
            lastSyncSpan.textContent = `Last sync: ${now.toLocaleTimeString()}`;
        }

        // Add material handler
        async function handleAddMaterial(e) {
            e.preventDefault();
            
            const material = {
                id: Date.now().toString(),
                materialName: document.getElementById('materialName').value,
                productNumber: document.getElementById('productNumber').value,
                referenceCode: document.getElementById('referenceCode').value,
                productCategory: document.getElementById('productCategory').value,
                purchaseUom: document.getElementById('purchaseUom').value,
                spmsCode: document.getElementById('spmsCode').value,
                priceIqd: parseFloat(document.getElementById('priceIqd').value),
                createdBy: currentUser,
                createdDate: new Date().toISOString()
            };

            try {
                // Add to local array
                materials.push(material);
                
                // Save to JSONBin
                await saveToJSONBin(materials);
                
                // Refresh data
                await refreshData();
                materialForm.reset();
                
                showToast('Material added successfully', 'success');
            } catch (error) {
                console.error('Error saving material:', error);
                showToast('Error saving material to cloud', 'danger');
                // Remove from local array if save failed
                materials = materials.filter(m => m.id !== material.id);
            }
        }

        // Save data to JSONBin
        async function saveToJSONBin(data) {
            const response = await fetch(`${JSONBIN_BASE_URL}/${binId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': apiKey
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error('Failed to save data to cloud');
            }
        }

        // Delete material
        async function deleteMaterial(id) {
            if (confirm('Are you sure you want to delete this material?')) {
                try {
                    // Remove from local array
                    materials = materials.filter(m => m.id !== id);
                    
                    // Save to JSONBin
                    await saveToJSONBin(materials);
                    
                    // Refresh data
                    await refreshData();
                    
                    showToast('Material deleted successfully', 'success');
                } catch (error) {
                    console.error('Error deleting material:', error);
                    showToast('Error deleting material from cloud', 'danger');
                }
            }
        }

        // Clear all data
        async function handleClearAll() {
            if (confirm('Are you sure you want to delete ALL materials? This action cannot be undone.')) {
                try {
                    await saveToJSONBin([]);
                    await refreshData();
                    showToast('All materials cleared', 'warning');
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showToast('Error clearing data from cloud', 'danger');
                }
            }
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(materials, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'materials_export.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Share Bin ID
        function shareBinId() {
            const shareText = `Join our Material Inventory System!\n\nBin ID: ${binId}\nAPI Key: [Your shared API key]\n\nUse the same Bin ID and API key to access shared data.`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showToast('Share instructions copied to clipboard!', 'info');
                });
            } else {
                // Fallback
                prompt('Copy this information to share with other users:', shareText);
            }
        }

        // Render materials table
        function renderMaterials() {
            materialsTableBody.innerHTML = '';
            
            if (materials.length === 0) {
                materialsTableBody.innerHTML = '<tr><td colspan="10" class="text-center">No materials found</td></tr>';
                return;
            }
            
            materials.forEach(material => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${material.materialName}</td>
                    <td>${material.productNumber}</td>
                    <td>${material.referenceCode}</td>
                    <td>${material.productCategory}</td>
                    <td>${material.purchaseUom}</td>
                    <td>${material.spmsCode}</td>
                    <td>${material.priceIqd ? material.priceIqd.toFixed(2) : '0.00'}</td>
                    <td>${material.createdBy}</td>
                    <td>${new Date(material.createdDate).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteMaterial('${material.id}')">Delete</button>
                    </td>
                `;
                materialsTableBody.appendChild(row);
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            const toast = createToast(message, type);
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }

        function createToast(message, type) {
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-bg-${type} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
            return toast;
        }
    </script>
</body>
</html>